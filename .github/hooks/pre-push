#!/bin/bash
# Pre-push hook for nutrition-fact-labeller-rust
# This hook runs cargo fmt, cargo test, and cargo clippy before pushing

set -e

echo "Running pre-push checks..."

# Check formatting
echo "ğŸ” Checking code formatting with cargo fmt..."
if ! cargo fmt --check; then
  echo "âŒ Code formatting check failed!"
  echo "   Run 'cargo fmt' to fix formatting issues."
  exit 1
fi
echo "âœ… Code formatting check passed"

# Run tests
echo "ğŸ§ª Running tests with cargo test..."
if ! cargo test 2>&1 | tee /tmp/test_output.log; then
  # Check if failure is due to build/dependency issues vs actual test failures
  if grep -q "failed to run custom build command\|Failed to GET\|No address associated with hostname" /tmp/test_output.log; then
    echo "âš ï¸  Tests skipped due to build/dependency issues (not a code problem)"
  else
    echo "âŒ Tests failed!"
    exit 1
  fi
fi
echo "âœ… Tests passed (or skipped due to environment)"

# Run linter
echo "ğŸ“‹ Running linter with cargo clippy..."
if ! cargo clippy -- -D warnings 2>&1 | tee /tmp/clippy_output.log; then
  # Check if failure is due to build/dependency issues vs actual linting failures
  if grep -q "failed to run custom build command\|Failed to GET\|No address associated with hostname" /tmp/clippy_output.log; then
    echo "âš ï¸  Linting skipped due to build/dependency issues (not a code problem)"
  else
    echo "âŒ Linting failed!"
    echo "   Run 'cargo clippy' to see and fix linting issues."
    exit 1
  fi
fi
echo "âœ… Linting passed (or skipped due to environment)"

echo "ğŸ‰ All pre-push checks passed!"
